name: Build and Package

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Install Linux and Windows Cross Compilers
      run: sudo apt-get install --yes --no-install-recommends musl-tools gcc-mingw-w64-x86-64-win32

    - name: Set up MacOS Cross Compiler
      uses: Timmmm/setup-osxcross@v2
      with:
        osx-version: "12.3"

    - name: Install Rustup targets
      run: rustup target add x86_64-unknown-linux-musl x86_64-pc-windows-gnu x86_64-apple-darwin aarch64-apple-darwin

    - name: Check out source code
      uses: actions/checkout@v3
    
    - name: Build
      run: |
        cargo install cross --git https://github.com/cross-rs/cross
        rustup target add x86_64-unknown-linux-gnu
        rustup target add aarch64-unknown-linux-gnu
        rustup target add x86_64-pc-windows-msvc
        rustup target add aarch64-pc-windows-msvc
        rustup target add x86_64-apple-darwin
        rustup target add x86_64-apple-darwin
        rustup target add aarch64-apple-darwin

        cross build --target aarch64-unknown-linux-gnu --release
        cross build --target x86_64-unknown-linux-gnu --release
        cross build --target x86_64-pc-windows-msvc --release
        cross build --target aarch64-pc-windows-msvc --release
        cross build --target aarch64-apple-darwin --release
        cross build --target x86_64-apple-darwin --release

    # - name: Build
    #   run: cargo build --target x86_64-unknown-linux-musl --target x86_64-pc-windows-gnu --target x86_64-apple-darwin --target aarch64-apple-darwin

    # - name: Archive artifacts
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: dockpack-${{ matrix.os }}-${{ matrix.target }}
    #     path: |
    #       target/${{ matrix.target }}/release/libdockpack.*  # Dynamic libraries (.dylib for macOS, .so for Linux)
    #       target/${{ matrix.target }}/release/dockpack*      # Binary executable
